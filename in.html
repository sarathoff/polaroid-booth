<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create nostalgic polaroid photos with filters and captions in your browser.">
    <title>The Timeless Photo Booth</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;700&family=Caveat:wght@600;700&family=Patrick+Hand&family=Special+Elite&display=swap" rel="stylesheet">

    <!-- Third-party library for creating screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-Mq1RIw0/GZ6n/7kkrH7x6Fml3U92KhkAHrN7OHoqEdVAh+EC6XoW28ZDD4Kgp6H7G4h28FzyP99kkrcpQCR0ZQ==" crossorigin="anonymous"></script>

    <style>
        :root {
            --font-sans: 'DM Sans', sans-serif;
            --font-display: 'Playfair Display', serif;
            --font-caveat: 'Caveat', cursive;
            --font-patrick: 'Patrick Hand', cursive;
            --font-elite: 'Special Elite', cursive;
            --color-bg: #F4F1EC;
            --color-text: #413B35;
            --color-text-muted: #7A7269;
            --color-card-bg: #FDFCFB;
            --color-border: #DED8CF;
            --color-input-bg: #FFFFFF;
            --color-primary: #856f5c;
            --color-primary-dark: #6a5949;
            --color-primary-text: #FFFFFF;
            --color-secondary: #EBE6DE;
            --color-secondary-text: #59514A;
            --shadow-color: 23deg 15% 55%;
            --shadow-light: 0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.22), 0.4px 0.8px 1px -0.8px hsl(var(--shadow-color) / 0.22), 1px 2px 2.5px -1.7px hsl(var(--shadow-color) / 0.22);
            --shadow-medium: 0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.2), 0.8px 1.6px 2px -0.6px hsl(var(--shadow-color) / 0.2), 2.1px 4.1px 5.2px -1.1px hsl(var(--shadow-color) / 0.2), 5px 10px 12.6px -1.7px hsl(var(--shadow-color) / 0.2);
            --shadow-polaroid: 0 10px 20px rgba(60, 60, 80, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            --shadow-polaroid-hover: 0 15px 30px rgba(60, 60, 80, 0.15), 0 5px 10px rgba(0, 0, 0, 0.12);
            --radius-small: 6px;
            --radius-medium: 12px;
            --radius-large: 16px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg);
            color: var(--color-text);
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="4" height="4" viewBox="0 0 4 4"%3E%3Cpath fill="%239C92AC" fill-opacity="0.06" d="M1 3h1v1H1V3zm2-2h1v1H3V1z"%3E%3C/path%3E%3C/svg%3E');
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .l-container {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 1.5rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4rem;
        }

        .header__logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        .header__logo:hover, .header__logo:focus {
            opacity: 0.8;
        }

        .header__nav {
            display: none;
        }

        #capture-section {
            display: none;
            grid-template-columns: 380px 1fr;
            gap: 2.5rem;
            align-items: flex-start;
        }

        #capture-section.is-active {
            display: grid;
        }

        .controls-panel {
            position: sticky;
            top: 1.5rem;
        }

        .preview-area {
            position: relative;
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .landing-section {
            text-align: center;
            padding: 3rem 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .landing-section.is-hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .landing-section h1 {
            font-family: var(--font-display);
            font-size: clamp(2.5rem, 6vw, 4rem);
            color: var(--color-text);
            margin-bottom: 1rem;
        }

        .landing-section p {
            font-size: 1.125rem;
            max-width: 60ch;
            margin: 0 auto 2rem;
            color: var(--color-text-muted);
        }

        .c-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.65rem 1rem;
            font-family: var(--font-sans);
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: var(--radius-small);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-out;
            white-space: nowrap;
        }

        .c-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .c-btn--primary {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-light);
        }

        .c-btn--primary:not(:disabled):hover, .c-btn--primary:not(:disabled):focus {
            background-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .c-btn--secondary {
            background-color: var(--color-secondary);
            color: var(--color-secondary-text);
            border-color: var(--color-border);
        }

        .c-btn--secondary:not(:disabled):hover, .c-btn--secondary:not(:disabled):focus {
            background-color: #e0d9cf;
            border-color: #cec5b9;
        }

        .c-btn svg {
            width: 16px;
            height: 16px;
        }

        .c-card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-large);
            padding: 1.5rem;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .c-video-container {
            position: relative;
            aspect-ratio: 16 / 9;
            border-radius: var(--radius-medium);
            overflow: hidden;
            background-color: var(--color-secondary);
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #cameraOverlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.4);
            color: white;
            font-size: 0.9rem;
            text-align: center;
            padding: 1rem;
            gap: 1rem;
        }

        .accordion__item {
            border-bottom: 1px solid var(--color-border);
        }

        .accordion__trigger {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-text);
        }

        .accordion__trigger .icon {
            color: var(--color-primary);
            margin-right: 0.75rem;
        }

        .accordion__chevron {
            transition: transform 0.3s ease;
        }

        .accordion__content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 0.25rem;
        }

        .accordion__content-inner {
            padding: 0.5rem 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .accordion__item.is-open .accordion__chevron {
            transform: rotate(180deg);
        }

        .c-option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 0.5rem;
        }

        .c-option-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 2px solid transparent;
            border-radius: var(--radius-medium);
            background-color: var(--color-input-bg);
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
            border: 1px solid var(--color-border);
            text-align: center;
        }

        .c-option-item:hover, .c-option-item:focus {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .c-option-item.is-active {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary);
        }

        .c-option-item__name {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--color-text-muted);
        }

        .filter-preview {
            width: 100%;
            height: 40px;
            border-radius: var(--radius-small);
            background-size: cover;
            background-position: center;
        }

        .font-preview {
            font-size: 1.5rem;
            line-height: 1;
        }

        .c-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .c-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--color-text-muted);
        }

        .c-input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: var(--radius-small);
            border: 1px solid var(--color-border);
            background-color: var(--color-input-bg);
            font-family: var(--font-sans);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .c-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-primary) 30%, transparent);
        }

        #emptyState {
            text-align: center;
            color: var(--color-text-muted);
        }

        #emptyState svg {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            opacity: 0.4;
        }

        #emptyState h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        .polaroid-wrapper, .polaroid-grid {
            transform-style: preserve-3d;
            perspective: 1500px;
        }

        .polaroid {
            background: var(--color-card-bg);
            border-radius: 4px;
            box-shadow: var(--shadow-polaroid);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            position: relative;
        }

        .polaroid:hover, .polaroid:focus-within {
            transform: scale(1.03) rotate(0deg) !important;
            box-shadow: var(--shadow-polaroid-hover);
            z-index: 10;
        }

        .polaroid__image-container {
            background-color: #e0e5f1;
            aspect-ratio: 1/1;
            overflow: hidden;
        }

        .polaroid__image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s ease;
        }

        .polaroid__text {
            text-align: center;
            padding: 0.5rem;
            color: #444;
            overflow-wrap: break-word;
        }

        .polaroid--single {
            width: 350px;
            padding: 1rem 1rem 4rem;
            transform: rotate(-2deg);
        }

        .polaroid--single .polaroid__image-container {
            margin-bottom: 1.25rem;
        }

        .polaroid--single .polaroid__text {
            font-size: 1.5rem;
        }

        .polaroid-grid {
            display: grid;
            max-width: 550px;
        }

        .polaroid-grid.polaroid-grid--2x2 {
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .polaroid-grid .polaroid {
            width: 100%;
            padding: 0.75rem 0.75rem 2.5rem;
        }

        .polaroid-grid .polaroid:nth-child(odd) {
            transform: rotate(-2.5deg);
        }

        .polaroid-grid .polaroid:nth-child(even) {
            transform: rotate(2.5deg);
        }

        .polaroid-grid .polaroid__image-container {
            margin-bottom: 0.75rem;
        }

        .polaroid-grid .polaroid__text {
            font-size: 1.2rem;
        }

        .polaroid-grid--strip {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--color-card-bg);
            box-shadow: var(--shadow-polaroid);
            max-width: 300px;
        }

        .polaroid-grid--strip .polaroid {
            box-shadow: none;
            transform: none !important;
        }

        .polaroid-grid--strip .polaroid:hover, .polaroid-grid--strip .polaroid:focus-within {
            transform: scale(1.05) !important;
        }

        .filter-vintage {
            filter: sepia(0.35) contrast(1.1) brightness(1.05) saturate(1.2);
        }

        .filter-mono {
            filter: grayscale(1);
        }

        .filter-retro {
            filter: sepia(0.6) contrast(0.9) brightness(1.1);
        }

        .hidden {
            display: none !important;
        }

        canvas {
            display: none;
        }

        .flash-effect {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .flash-effect.is-active {
            animation: flash 0.3s ease-out;
        }

        #countdownOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }

        #countdownOverlay.is-active {
            opacity: 1;
            pointer-events: all;
        }

        #countdownNumber {
            font-family: var(--font-display);
            font-size: 10rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transform-origin: center;
        }

        #thumbnailContainer {
            background-color: var(--color-secondary);
            padding: 0.5rem;
            border-radius: var(--radius-medium);
        }

        #thumbnailTray {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: thin;
        }

        .thumbnail-item {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-small);
            object-fit: cover;
            border: 2px solid var(--color-border);
            cursor: pointer;
        }

        .c-card__section-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #downloadFab {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-primary);
            color: var(--color-primary-text);
            border: none;
            box-shadow: var(--shadow-medium);
            z-index: 20;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        #downloadFab.is-visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }

        #downloadFab:hover, #downloadFab:focus {
            background-color: var(--color-primary-dark);
            transform: scale(1.05);
        }

        #downloadFab svg {
            width: 24px;
            height: 24px;
        }

        #layoutHelper {
            font-size: 0.8rem;
            text-align: center;
            color: var(--color-text-muted);
            background: var(--color-secondary);
            padding: 0.5rem;
            border-radius: var(--radius-small);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.9; }
            100% { opacity: 0; }
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (min-width: 768px) {
            .header__nav {
                display: block;
            }
        }

        @media (max-width: 992px) {
            #capture-section {
                grid-template-columns: 1fr;
            }
            .controls-panel {
                position: static;
                max-width: 500px;
                margin: 0 auto;
            }
            .preview-area {
                min-height: auto;
                padding-top: 2rem;
            }
        }

        @media (max-width: 480px) {
            .polaroid--single, .polaroid-grid--strip {
                width: 100%;
                max-width: 100%;
            }
            .polaroid-grid.polaroid-grid--2x2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Overlays -->
    <div id="flashEffect" class="flash-effect"></div>
    <div id="countdownOverlay" aria-live="polite">
        <div id="countdownNumber"></div>
    </div>

    <div class="l-container">
        <header class="header">
            <a href="#" class="header__logo" aria-label="The Timeless Photo Booth Home">The Photo Booth</a>
        </header>

        <!-- Landing Page Section -->
        <section id="landing-section" class="landing-section">
            <h1>The Timeless Photo Booth</h1>
            <p>Create beautiful, nostalgic polaroid photos right from your browser. Capture a moment, add a vintage filter, write a caption, and keep the memory forever.</p>
            <button id="getStartedBtn" class="c-btn c-btn--primary" style="padding: 0.8rem 2rem; font-size: 1rem;" aria-label="Start a new photo booth session">
                ✨ Start a Session
            </button>
        </section>

        <!-- Main Capturing App -->
        <main id="capture-section" aria-hidden="true">
            <!-- CONTROLS PANEL -->
            <aside class="controls-panel">
                <div class="c-card">
                    <!-- 1. CAMERA & CAPTURE -->
                    <div class="c-video-container">
                        <video id="videoElement" autoplay muted playsinline aria-label="Live camera feed"></video>
                        <div id="cameraOverlay" role="alert">Loading...</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="c-btn c-btn--primary" id="smartCaptureBtn" disabled aria-label="Take photo or start sequence">Take Photo</button>
                        <button class="c-btn c-btn--secondary" id="uploadBtn" aria-label="Upload images">Upload</button>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" multiple aria-label="Upload images for polaroid">
                    </div>
                    <button class="c-btn c-btn--secondary" id="switchCameraBtn" style="margin-top: 0.5rem;" aria-label="Switch camera">Switch Camera</button>

                    <!-- 2. CURRENT SHOTS -->
                    <div id="thumbnailContainer" class="hidden">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div class="c-card__section-title">Current Shots</div>
                            <button class="c-btn c-btn--secondary" id="clearBtn" style="padding: 0.2rem 0.5rem; font-size: 0.75rem;" disabled aria-label="Clear all captured images">Clear</button>
                        </div>
                        <div id="thumbnailTray" role="list"></div>
                    </div>

                    <!-- 3. CUSTOMIZATION -->
                    <div class="accordion-container">
                        <div class="accordion__item is-open">
                            <button class="accordion__trigger" aria-expanded="true" aria-controls="layout-content">
                                <span style="display: flex; align-items: center;">
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect width="18" height="18" x="3" y="3" rx="2"/>
                                        <path d="M3 9h18"/><path d="M9 21V9"/>
                                    </svg> Layout
                                </span>
                                <svg class="accordion__chevron" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </button>
                            <div class="accordion__content" id="layout-content" style="max-height: 500px;">
                                <div class="accordion__content-inner" style="gap: 1.25rem;">
                                    <div class="c-input-group">
                                        <div id="layoutOptions" class="c-option-grid" role="radiogroup" aria-label="Select layout"></div>
                                    </div>
                                    <div id="layoutHelper" role="status">Takes 1 photo instantly.</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="c-input-group">
                                            <label class="c-label" for="timerDelay">Countdown (seconds)</label>
                                            <input type="number" id="timerDelay" min="1" max="10" value="3" class="c-input" aria-label="Set countdown timer duration">
                                        </div>
                                        <div class="c-input-group">
                                            <label class="c-label" for="photoCount">Photos</label>
                                            <input type="number" id="photoCount" min="1" max="4" value="1" class="c-input" disabled aria-label="Number of photos in layout">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion__item">
                            <button class="accordion__trigger" aria-expanded="false" aria-controls="filter-content">
                                <span style="display: flex; align-items: center;">
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 2a7 7 0 1 0 10 10"/>
                                    </svg> Image Filter
                                </span>
                                <svg class="accordion__chevron" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </button>
                            <div class="accordion__content" id="filter-content">
                                <div class="accordion__content-inner">
                                    <div class="c-option-grid" id="filterOptions" role="radiogroup" aria-label="Select image filter"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion__item">
                            <button class="accordion__trigger" aria-expanded="false" aria-controls="font-content">
                                <span style="display: flex; align-items: center;">
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="4 7 4 4 20 4 20 7"/>
                                        <line x1="9" x2="15" y1="20" y2="20"/>
                                        <line x1="12" x2="12" y1="4" y2="20"/>
                                    </svg> Font Style
                                </span>
                                <svg class="accordion__chevron" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </button>
                            <div class="accordion__content" id="font-content">
                                <div class="accordion__content-inner">
                                    <div class="c-option-grid" id="fontOptions" role="radiogroup" aria-label="Select font style"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. FINAL TOUCHES -->
                    <div style="padding-top: 1rem; border-top: 1px solid var(--color-border); display: flex; flex-direction: column; gap: 1rem;">
                        <div class="c-card__section-title">Add A Caption</div>
                        <input type="text" id="polaroidText" placeholder="Write a memory..." maxlength="60" class="c-input" aria-label="Enter caption for polaroid">
                    </div>
                </div>
            </aside>

            <!-- PREVIEW AREA -->
            <section class="preview-area" aria-live="polite">
                <div id="polaroidContainer">
                    <div id="emptyState">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                            <circle cx="9" cy="9" r="2"/>
                            <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                        </svg>
                        <h3>Your Photos Appear Here</h3>
                        <p>Use the controls on the left to create your memory.</p>
                    </div>
                </div>
                <button id="downloadFab" aria-label="Download polaroid image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" x2="12" y1="15" y2="3"/>
                    </svg>
                </button>
            </section>
        </main>
    </div>

    <canvas id="canvas" aria-hidden="true"></canvas>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        class PolaroidMaker {
            constructor() {
                this.config = {
                    filters: {
                        'none': { name: 'None', value: 'none' },
                        'vintage': { name: 'Vintage', value: 'sepia(0.35) contrast(1.1) brightness(1.05) saturate(1.2)' },
                        'mono': { name: 'Mono', value: 'grayscale(1)' },
                        'retro': { name: 'Retro', value: 'sepia(0.6) contrast(0.9) brightness(1.1)' },
                    },
                    fonts: {
                        'Caveat': 'Cute',
                        'Patrick Hand': 'Neat',
                        'Special Elite': 'Typed'
                    },
                    layouts: {
                        'single': {
                            name: 'Single',
                            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>`,
                            photoCount: 1
                        },
                        'grid-2x2': {
                            name: '2x2 Grid',
                            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="8" x="3" y="3" rx="1"/><rect width="8" height="8" x="13" y="3" rx="1"/><rect width="8" height="8" x="3" y="13" rx="1"/><rect width="8" height="8" x="13" y="13" rx="1"/></svg>`,
                            photoCount: 4
                        },
                        'grid-strip': {
                            name: 'Strip',
                            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="20" x="8" y="2" rx="2" ry="2"/></svg>`,
                            photoCount: 4
                        }
                    }
                };

                this.els = {
                    video: document.getElementById('videoElement'),
                    canvas: document.getElementById('canvas'),
                    smartCaptureBtn: document.getElementById('smartCaptureBtn'),
                    uploadBtn: document.getElementById('uploadBtn'),
                    fileInput: document.getElementById('fileInput'),
                    switchCameraBtn: document.getElementById('switchCameraBtn'),
                    downloadFab: document.getElementById('downloadFab'),
                    polaroidContainer: document.getElementById('polaroidContainer'),
                    polaroidText: document.getElementById('polaroidText'),
                    flashEffect: document.getElementById('flashEffect'),
                    cameraOverlay: document.getElementById('cameraOverlay'),
                    emptyState: document.getElementById('emptyState'),
                    layoutOptions: document.getElementById('layoutOptions'),
                    timerDelay: document.getElementById('timerDelay'),
                    photoCount: document.getElementById('photoCount'),
                    countdownOverlay: document.getElementById('countdownOverlay'),
                    countdownNumber: document.getElementById('countdownNumber'),
                    filterOptions: document.getElementById('filterOptions'),
                    fontOptions: document.getElementById('fontOptions'),
                    thumbnailContainer: document.getElementById('thumbnailContainer'),
                    thumbnailTray: document.getElementById('thumbnailTray'),
                    clearBtn: document.getElementById('clearBtn'),
                    layoutHelper: document.getElementById('layoutHelper')
                };

                this.ctx = this.els.canvas.getContext('2d', { willReadFrequently: true });
                this.currentLayout = 'single';
                this.currentFilter = 'none';
                this.currentFont = 'Caveat';
                this.capturedImages = [];
                this.isStreaming = false;
                this.stream = null;
                this.isTimerActive = false;
                this.facingMode = 'user';
                this.maxFileSize = 5 * 1024 * 1024; // 5MB limit for uploads

                this.init();
            }

            init() {
                this.initUI();
                this.bindGlobalEvents();
                this.selectLayout(document.querySelector('.layout-option.is-active'));
            }

            initUI() {
                const filterPreviewUrl = 'https://images.unsplash.com/photo-1579546929518-9e396f3a8034?w=100';
                this.els.filterOptions.innerHTML = Object.entries(this.config.filters).map(([id, { name, value }]) => `
                    <button class="c-option-item filter-option ${id === 'none' ? 'is-active' : ''}" data-filter="${id}" role="radio" aria-checked="${id === 'none'}" tabindex="0">
                        <div class="filter-preview" style="background-image: url('${filterPreviewUrl}'); filter: ${value};" aria-hidden="true"></div>
                        <span class="c-option-item__name">${this.sanitizeHTML(name)}</span>
                    </button>`).join('');

                this.els.fontOptions.innerHTML = Object.entries(this.config.fonts).map(([font, name]) => `
                    <button class="c-option-item font-option ${font === 'Caveat' ? 'is-active' : ''}" data-font="${font}" role="radio" aria-checked="${font === 'Caveat'}" tabindex="0">
                        <div class="font-preview" style="font-family: var(--font-${font.toLowerCase().replace(' ', '-')})">Ag</div>
                        <span class="c-option-item__name">${this.sanitizeHTML(name)}</span>
                    </button>`).join('');

                this.els.layoutOptions.innerHTML = Object.entries(this.config.layouts).map(([id, { name, icon }]) => `
                    <button class="c-option-item layout-option ${id === 'single' ? 'is-active' : ''}" data-layout="${id}" role="radio" aria-checked="${id === 'single'}" tabindex="0">
                        ${icon}
                        <span class="c-option-item__name">${this.sanitizeHTML(name)}</span>
                    </button>`).join('');

                this.selectFont(document.querySelector('.font-option.is-active'));
            }

            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            bindGlobalEvents() {
                document.getElementById('getStartedBtn').addEventListener('click', () => this.startApp());
                this.els.smartCaptureBtn.addEventListener('click', () => this.handleSmartCapture());
                this.els.uploadBtn.addEventListener('click', () => this.els.fileInput.click());
                this.els.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.els.switchCameraBtn.addEventListener('click', () => this.switchCamera());
                this.els.downloadFab.addEventListener('click', () => this.downloadPolaroid());
                this.els.polaroidText.addEventListener('input', () => this.updatePolaroidText());
                this.els.clearBtn.addEventListener('click', () => this.clearImages());

                document.querySelectorAll('.layout-option').forEach(o => {
                    o.addEventListener('click', (e) => this.selectLayout(e.currentTarget));
                    o.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.selectLayout(e.currentTarget);
                        }
                    });
                });

                document.querySelectorAll('.filter-option').forEach(o => {
                    o.addEventListener('click', (e) => this.selectFilter(e.currentTarget));
                    o.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.selectFilter(e.currentTarget);
                        }
                    });
                });

                document.querySelectorAll('.font-option').forEach(o => {
                    o.addEventListener('click', (e) => this.selectFont(e.currentTarget));
                    o.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.selectFont(e.currentTarget);
                        }
                    });
                });

                document.querySelectorAll('.accordion__trigger').forEach(trigger => {
                    trigger.addEventListener('click', () => this.toggleAccordion(trigger));
                    trigger.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.toggleAccordion(trigger);
                        }
                    });
                });

                this.els.thumbnailTray.addEventListener('click', (e) => {
                    if (e.target.classList.contains('thumbnail-item')) {
                        const index = Array.from(this.els.thumbnailTray.children).indexOf(e.target);
                        this.capturedImages.splice(index, 1);
                        this.renderAll();
                    }
                });
            }

            toggleAccordion(trigger) {
                const item = trigger.parentElement;
                const content = trigger.nextElementSibling;
                const wasOpen = item.classList.contains('is-open');

                document.querySelectorAll('.accordion__item').forEach(i => {
                    i.classList.remove('is-open');
                    i.querySelector('.accordion__content').style.maxHeight = '0px';
                    i.querySelector('.accordion__trigger').setAttribute('aria-expanded', 'false');
                });

                if (!wasOpen) {
                    item.classList.add('is-open');
                    content.style.maxHeight = content.scrollHeight + 'px';
                    trigger.setAttribute('aria-expanded', 'true');
                }
            }

            async startApp() {
                document.getElementById('landing-section').classList.add('is-hidden');
                setTimeout(() => {
                    document.getElementById('landing-section').style.display = 'none';
                    this.els.captureSection.classList.add('is-active');
                    this.els.captureSection.setAttribute('aria-hidden', 'false');
                    this.els.captureSection.style.animation = 'fadeIn 0.8s ease-in forwards';
                }, 500);

                try {
                    await this.startCamera();
                } catch (err) {
                    console.error('Camera failed to start:', err);
                    this.showCameraErrorState(err.message);
                }
            }

            async startCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: this.facingMode }
                    });
                    this.els.video.srcObject = this.stream;
                    this.els.video.onloadedmetadata = () => {
                        this.isStreaming = true;
                        this.els.cameraOverlay.classList.add('hidden');
                        this.els.smartCaptureBtn.disabled = false;
                    };
                } catch (err) {
                    throw new Error('Unable to access camera: ' + err.message);
                }
            }

            switchCamera() {
                this.facingMode = this.facingMode === 'user' ? 'environment' : 'user';
                this.startApp();
            }

            showCameraErrorState(message) {
                this.els.cameraOverlay.classList.remove('hidden');
                this.els.cameraOverlay.innerHTML = `
                    <span>Could not access camera: ${this.sanitizeHTML(message)}</span>
                    <span>Please grant permission or try uploading photos instead.</span>
                    <button id="retryCameraBtn" class="c-btn c-btn--secondary" style="margin-top: 0.5rem" aria-label="Retry camera access">Retry</button>
                `;
                document.getElementById('retryCameraBtn').addEventListener('click', () => this.startApp());
                this.els.smartCaptureBtn.disabled = true;
            }

            handleSmartCapture() {
                if (!this.isStreaming || this.isTimerActive) return;
                const layoutConf = this.config.layouts[this.currentLayout];
                if (layoutConf.photoCount === 1) {
                    this.capturePhoto();
                } else {
                    this.startTimer();
                }
            }

            capturePhoto() {
                if (!this.isStreaming) return;
                this.triggerFlash();
                this.els.canvas.width = this.els.video.videoWidth;
                this.els.canvas.height = this.els.video.videoHeight;
                if (this.facingMode === 'user') {
                    this.ctx.translate(this.els.canvas.width, 0);
                    this.ctx.scale(-1, 1);
                }
                this.ctx.drawImage(this.els.video, 0, 0, this.els.canvas.width, this.els.canvas.height);
                this.addCapturedImage(this.els.canvas.toDataURL('image/jpeg', 0.95));
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
            }

            handleFileUpload(event) {
                const files = event.target.files;
                if (!files.length) return;

                Array.from(files).forEach(file => {
                    if (file.size > this.maxFileSize) {
                        alert(`File ${file.name} is too large. Maximum size is 5MB.`);
                        return;
                    }
                    if (!file.type.startsWith('image/')) {
                        alert(`File ${file.name} is not an image.`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => this.addCapturedImage(e.target.result);
                    reader.onerror = () => alert(`Error reading file ${file.name}.`);
                    reader.readAsDataURL(file);
                });
                event.target.value = '';
            }

            addCapturedImage(imageData) {
                const maxImages = this.config.layouts[this.currentLayout].photoCount;
                if (this.capturedImages.length >= maxImages) {
                    this.capturedImages.shift();
                }
                this.capturedImages.push(imageData);
                this.renderAll();
            }

            clearImages() {
                this.capturedImages = [];
                this.renderAll();
            }

            selectLayout(option) {
                document.querySelectorAll('.layout-option').forEach(o => {
                    o.classList.remove('is-active');
                    o.setAttribute('aria-checked', 'false');
                });
                option.classList.add('is-active');
                option.setAttribute('aria-checked', 'true');
                this.currentLayout = option.dataset.layout;

                const layoutConf = this.config.layouts[this.currentLayout];
                const photoCount = layoutConf.photoCount;
                this.els.photoCount.value = photoCount;
                this.els.timerDelay.disabled = (photoCount === 1);

                if (photoCount > 1) {
                    this.els.layoutHelper.textContent = `Takes ${photoCount} photos automatically.`;
                    this.els.smartCaptureBtn.textContent = `Start Sequence`;
                } else {
                    this.els.layoutHelper.textContent = `Takes 1 photo instantly.`;
                    this.els.smartCaptureBtn.textContent = `Take Photo`;
                }

                if (this.capturedImages.length > photoCount) {
                    this.capturedImages = this.capturedImages.slice(-photoCount);
                }
                this.renderAll();
            }

            selectFilter(option) {
                document.querySelectorAll('.filter-option').forEach(o => {
                    o.classList.remove('is-active');
                    o.setAttribute('aria-checked', 'false');
                });
                option.classList.add('is-active');
                option.setAttribute('aria-checked', 'true');
                this.currentFilter = option.dataset.filter;
                this.renderAll();
            }

            selectFont(option) {
                document.querySelectorAll('.font-option').forEach(o => {
                    o.classList.remove('is-active');
                    o.setAttribute('aria-checked', 'false');
                });
                option.classList.add('is-active');
                option.setAttribute('aria-checked', 'true');
                this.currentFont = option.dataset.font;
                this.els.polaroidText.style.fontFamily = `var(--font-${this.currentFont.toLowerCase().replace(' ', '-')})`;
                this.updatePolaroidText();
            }

            renderAll() {
                this.renderPolaroid();
                this.renderThumbnails();
                this.updateButtonStates();
            }

            renderThumbnails() {
                if (this.capturedImages.length === 0) {
                    this.els.thumbnailContainer.classList.add('hidden');
                    return;
                }
                this.els.thumbnailContainer.classList.remove('hidden');
                this.els.thumbnailTray.innerHTML = this.capturedImages.map((src, index) => `
                    <img src="${src}" class="thumbnail-item" role="button" aria-label="Remove image ${index + 1}" tabindex="0">
                `).join('');
            }

            renderPolaroid() {
                if (this.capturedImages.length === 0) {
                    this.els.polaroidContainer.innerHTML = this.els.emptyState.outerHTML;
                    return;
                }
                const text = this.sanitizeHTML(this.els.polaroidText.value);
                const imagesToRender = this.capturedImages.slice(-this.config.layouts[this.currentLayout].photoCount);
                const filterClass = `filter-${this.currentFilter}`;
                const fontStyle = `font-family: var(--font-${this.currentFont.toLowerCase().replace(' ', '-')});`;
                const emptyImgSrc = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

                let html = '';
                const renderSinglePolaroid = (imgSrc, showText, alt) => `
                    <div class="polaroid">
                        <div class="polaroid__image-container">
                            <img src="${imgSrc}" class="polaroid__image ${filterClass}" alt="${this.sanitizeHTML(alt)}">
                        </div>
                        <div class="polaroid__text" style="${fontStyle}">${showText ? text : ''}</div>
                    </div>`;

                if (this.currentLayout === 'single') {
                    html = `<div class="polaroid-wrapper">${renderSinglePolaroid(imagesToRender[0] || emptyImgSrc, true, 'Captured Photo')}</div>`;
                } else if (this.currentLayout === 'grid-2x2') {
                    html = `<div class="polaroid-grid polaroid-grid--2x2">`;
                    for (let i = 0; i < 4; i++) {
                        html += renderSinglePolaroid(imagesToRender[i] || emptyImgSrc, i === imagesToRender.length - 1, `Grid photo ${i + 1}`);
                    }
                    html += `</div>`;
                } else if (this.currentLayout === 'grid-strip') {
                    html = `<div class="polaroid-grid polaroid-grid--strip">`;
                    for (let i = 0; i < 4; i++) {
                        html += renderSinglePolaroid(imagesToRender[i] || emptyImgSrc, i === imagesToRender.length - 1, `Strip photo ${i + 1}`);
                    }
                    html += `</div>`;
                }

                this.els.polaroidContainer.innerHTML = html;
            }

            updatePolaroidText() {
                const textElements = document.querySelectorAll('.polaroid__text');
                if (textElements.length === 0) return;
                textElements.forEach(el => el.textContent = '');
                const lastTextEl = textElements[textElements.length - 1];
                if (lastTextEl) lastTextEl.textContent = this.sanitizeHTML(this.els.polaroidText.value);
            }

            updateButtonStates() {
                const hasImages = this.capturedImages.length > 0;
                this.els.downloadFab.classList.toggle('is-visible', hasImages);
                this.els.clearBtn.disabled = !hasImages;
            }

            startTimer() {
                if (!this.isStreaming || this.isTimerActive) return;
                this.isTimerActive = true;
                this.photosToTake = this.config.layouts[this.currentLayout].photoCount;
                this.clearImages();

                this.els.smartCaptureBtn.textContent = 'Sequence in Progress...';
                this.els.smartCaptureBtn.disabled = true;

                const runCaptureSequence = () => {
                    if (!this.isTimerActive || this.capturedImages.length >= this.photosToTake) {
                        this.stopTimer();
                        return;
                    }

                    this.showCountdown(parseInt(this.els.timerDelay.value) || 3, () => {
                        this.capturePhoto();
                        if (this.capturedImages.length < this.photosToTake) {
                            setTimeout(runCaptureSequence, 1000);
                        } else {
                            this.stopTimer();
                        }
                    });
                };
                runCaptureSequence();
            }

            stopTimer() {
                this.isTimerActive = false;
                this.els.smartCaptureBtn.textContent = 'Start Sequence';
                this.els.smartCaptureBtn.disabled = false;
            }

            showCountdown(seconds, onComplete) {
                this.els.countdownOverlay.classList.add('is-active');
                let count = seconds;
                const tick = () => {
                    const numberEl = this.els.countdownNumber;
                    numberEl.style.animation = 'none';
                    numberEl.offsetHeight;
                    numberEl.style.animation = 'countdownPulse 1s ease-out';

                    const nextPhotoNum = this.capturedImages.length + 1;
                    numberEl.textContent = count > 0 ? count : `📸 ${nextPhotoNum}`;

                    if (count > 0) {
                        count--;
                        setTimeout(tick, 1000);
                    } else {
                        setTimeout(() => {
                            this.els.countdownOverlay.classList.remove('is-active');
                            onComplete();
                        }, 800);
                    }
                };
                tick();
            }

            triggerFlash() {
                this.els.flashEffect.classList.add('is-active');
                setTimeout(() => this.els.flashEffect.classList.remove('is-active'), 300);
            }

            downloadPolaroid() {
                const nodeToCapture = document.querySelector('#polaroidContainer > div');
                if (!nodeToCapture) {
                    alert('Nothing to download!');
                    return;
                }

                nodeToCapture.style.transform = 'rotate(0deg)';
                nodeToCapture.style.transition = 'none';

                html2canvas(nodeToCapture, {
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: null,
                    scale: 2,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `photobooth-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    nodeToCapture.style.transition = '';
                    this.renderPolaroid();
                }).catch(err => {
                    console.error('Download failed:', err);
                    alert('Sorry, the download failed. Please try again.');
                    nodeToCapture.style.transition = '';
                    this.renderPolaroid();
                });
            }
        }

        new PolaroidMaker();
    });
    </script>
</body>
</html>